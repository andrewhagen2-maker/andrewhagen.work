---
// ScanDashboard.astro — reads from /api/scans, renders stats + sortable/filterable table
---

<div class="dashboard" id="dashboard">

  <!-- Loading state -->
  <p class="status-msg" id="status-msg">Loading scan data…</p>

  <!-- Stats bar — hidden until data loads -->
  <div class="stats" id="stats" hidden>
    <div class="stat">
      <span class="stat-value" id="stat-total">—</span>
      <span class="stat-label">Total Scans</span>
    </div>
    <div class="stat">
      <span class="stat-value" id="stat-codes">—</span>
      <span class="stat-label">Unique Codes</span>
    </div>
    <div class="stat">
      <span class="stat-value" id="stat-distributors">—</span>
      <span class="stat-label">Distributors</span>
    </div>
    <div class="stat">
      <span class="stat-value" id="stat-latest">—</span>
      <span class="stat-label">Last Scan</span>
    </div>
  </div>

  <!-- Controls — hidden until data loads -->
  <div class="controls" id="controls" hidden>
    <div class="filter-wrap">
      <label class="field-label" for="filter-distributor">Filter by distributor</label>
      <select class="filter-select" id="filter-distributor">
        <option value="">All distributors</option>
      </select>
    </div>
    <button class="btn btn--secondary" id="refresh-btn" type="button">Refresh</button>
  </div>

  <!-- Table — hidden until data loads -->
  <div class="table-wrap" id="table-wrap" hidden>
    <table class="scan-table" id="scan-table">
      <thead>
        <tr>
          <th class="sortable" data-col="timestamp">Timestamp <span class="sort-indicator" data-col="timestamp">↕</span></th>
          <th class="sortable" data-col="distributor">Distributor <span class="sort-indicator" data-col="distributor">↕</span></th>
          <th class="sortable" data-col="code_id">Code ID <span class="sort-indicator" data-col="code_id">↕</span></th>
          <th class="sortable" data-col="country">Country <span class="sort-indicator" data-col="country">↕</span></th>
          <th>Device</th>
        </tr>
      </thead>
      <tbody id="scan-tbody"></tbody>
    </table>
    <p class="table-empty" id="table-empty" hidden>No scans match the current filter.</p>
  </div>

</div>

<script>
  // Parse user-agent into a readable device string
  function parseDevice(ua) {
    if (!ua) return '—';
    const s = ua.toLowerCase();
    let device = 'Desktop';
    if (s.includes('iphone')) device = 'iPhone';
    else if (s.includes('ipad')) device = 'iPad';
    else if (s.includes('android') && s.includes('mobile')) device = 'Android Phone';
    else if (s.includes('android')) device = 'Android Tablet';

    let browser = '';
    if (s.includes('edg/')) browser = 'Edge';
    else if (s.includes('chrome') && !s.includes('chromium')) browser = 'Chrome';
    else if (s.includes('safari') && !s.includes('chrome')) browser = 'Safari';
    else if (s.includes('firefox')) browser = 'Firefox';

    return browser ? `${device} / ${browser}` : device;
  }

  // Format ISO timestamp to readable local string
  function formatTimestamp(iso) {
    if (!iso) return '—';
    try {
      const d = new Date(iso);
      return d.toLocaleString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric',
        hour: '2-digit', minute: '2-digit',
      });
    } catch {
      return iso;
    }
  }

  let allScans = [];
  let sortCol = 'timestamp';
  let sortDir = 'desc'; // newest first by default

  const statusMsg = document.getElementById('status-msg');
  const statsEl = document.getElementById('stats');
  const controlsEl = document.getElementById('controls');
  const tableWrap = document.getElementById('table-wrap');
  const tbody = document.getElementById('scan-tbody');
  const tableEmpty = document.getElementById('table-empty');
  const filterSelect = document.getElementById('filter-distributor');
  const refreshBtn = document.getElementById('refresh-btn');

  const statTotal = document.getElementById('stat-total');
  const statCodes = document.getElementById('stat-codes');
  const statDistributors = document.getElementById('stat-distributors');
  const statLatest = document.getElementById('stat-latest');

  async function loadScans() {
    statusMsg.textContent = 'Loading scan data…';
    statusMsg.hidden = false;
    statsEl.hidden = true;
    controlsEl.hidden = true;
    tableWrap.hidden = true;

    try {
      const res = await fetch('/api/scans');
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Server error');
      allScans = data.scans || [];
    } catch (err) {
      statusMsg.textContent = `Failed to load scan data: ${err.message}`;
      return;
    }

    statusMsg.hidden = true;
    renderStats();
    populateFilter();
    renderTable();
    statsEl.hidden = false;
    controlsEl.hidden = false;
    tableWrap.hidden = false;
  }

  function renderStats() {
    const total = allScans.length;
    const uniqueCodes = new Set(allScans.map(s => s.code_id)).size;
    const uniqueDistributors = new Set(allScans.map(s => s.distributor)).size;
    const latest = allScans.length > 0
      ? formatTimestamp(allScans[0].timestamp) // already sorted newest-first
      : 'No scans yet';

    statTotal.textContent = total;
    statCodes.textContent = uniqueCodes;
    statDistributors.textContent = uniqueDistributors;
    statLatest.textContent = latest;
  }

  function populateFilter() {
    const distributors = [...new Set(allScans.map(s => s.distributor))].sort();
    // Clear existing options beyond "All"
    while (filterSelect.options.length > 1) filterSelect.remove(1);
    distributors.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      filterSelect.appendChild(opt);
    });
  }

  function getFilteredSorted() {
    const filterVal = filterSelect.value;
    let rows = filterVal
      ? allScans.filter(s => s.distributor === filterVal)
      : [...allScans];

    rows.sort((a, b) => {
      let av = a[sortCol] || '';
      let bv = b[sortCol] || '';
      // Numeric sort for timestamps, alpha for others
      if (sortCol === 'timestamp') {
        av = new Date(av).getTime() || 0;
        bv = new Date(bv).getTime() || 0;
        return sortDir === 'asc' ? av - bv : bv - av;
      }
      return sortDir === 'asc'
        ? av.localeCompare(bv)
        : bv.localeCompare(av);
    });

    return rows;
  }

  function renderTable() {
    const rows = getFilteredSorted();
    tbody.innerHTML = '';

    if (rows.length === 0) {
      tableEmpty.hidden = false;
      return;
    }
    tableEmpty.hidden = true;

    rows.forEach(scan => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatTimestamp(scan.timestamp)}</td>
        <td>${scan.distributor || '—'}</td>
        <td class="code-cell"><code>${scan.code_id || '—'}</code></td>
        <td>${scan.country || '—'}</td>
        <td>${parseDevice(scan.user_agent)}</td>
      `;
      tbody.appendChild(tr);
    });

    // Update sort indicators
    document.querySelectorAll('.sort-indicator').forEach(el => {
      const col = el.dataset.col;
      if (col === sortCol) {
        el.textContent = sortDir === 'asc' ? '↑' : '↓';
      } else {
        el.textContent = '↕';
      }
    });
  }

  // Column sort on header click
  document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.col;
      if (sortCol === col) {
        sortDir = sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        sortCol = col;
        sortDir = 'asc';
      }
      renderTable();
    });
  });

  // Filter change
  filterSelect.addEventListener('change', renderTable);

  // Refresh button
  refreshBtn.addEventListener('click', loadScans);

  // Initial load
  loadScans();
</script>

<style>
  .dashboard {
    width: 100%;
  }

  .status-msg {
    font-size: var(--size-sm);
    color: var(--color-subtle);
    padding: var(--space-md) 0;
  }

  /* Stats bar */
  .stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1px;
    background: var(--color-text);
    border: 1px solid var(--color-text);
    margin-bottom: var(--space-md);
  }

  .stat {
    background: var(--color-bg);
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    padding: var(--space-md);
  }

  .stat-value {
    font-size: var(--size-2xl);
    font-weight: 500;
    letter-spacing: -0.01em;
    line-height: 1;
    color: var(--color-text);
  }

  /* Shrink last scan timestamp so it fits */
  #stat-latest {
    font-size: var(--size-base);
  }

  .stat-label {
    font-size: var(--size-xs);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--color-subtle);
  }

  /* Controls row */
  .controls {
    display: flex;
    align-items: flex-end;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
    flex-wrap: wrap;
  }

  .filter-wrap {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .field-label {
    font-size: var(--size-xs);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--color-subtle);
  }

  .filter-select {
    background: transparent;
    border: 1px solid var(--color-text);
    color: var(--color-text);
    font-family: var(--font-base);
    font-size: var(--size-sm);
    font-weight: 300;
    padding: 0.5rem 0.75rem;
    outline: none;
    border-radius: 0;
    -webkit-appearance: none;
    cursor: pointer;
    min-width: 200px;
  }

  .filter-select:focus {
    border-color: var(--accent-1);
  }

  /* Buttons */
  .btn {
    background: var(--color-text);
    color: var(--color-bg);
    border: 1px solid var(--color-text);
    font-family: var(--font-base);
    font-size: var(--size-xs);
    font-weight: 500;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    border-radius: 0;
  }

  .btn:hover {
    background: var(--accent-1);
    border-color: var(--accent-1);
  }

  .btn--secondary {
    background: transparent;
    color: var(--color-text);
  }

  .btn--secondary:hover {
    background: transparent;
    color: var(--accent-1);
    border-color: var(--accent-1);
  }

  /* Table */
  .table-wrap {
    width: 100%;
    overflow-x: auto;
  }

  .scan-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--size-sm);
  }

  .scan-table thead tr {
    border-bottom: 2px solid var(--color-text);
  }

  .scan-table th {
    text-align: left;
    font-size: var(--size-xs);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--color-subtle);
    padding: 0.6rem 1rem 0.6rem 0;
    white-space: nowrap;
    font-weight: 400;
  }

  .scan-table th.sortable {
    cursor: pointer;
    user-select: none;
  }

  .scan-table th.sortable:hover {
    color: var(--accent-1);
  }

  .sort-indicator {
    display: inline-block;
    margin-left: 0.3rem;
    opacity: 0.5;
    font-size: 0.7em;
  }

  .scan-table td {
    padding: 0.75rem 1rem 0.75rem 0;
    border-bottom: 1px solid rgba(42, 39, 36, 0.12);
    color: var(--color-text);
    vertical-align: top;
  }

  .scan-table tbody tr:last-child td {
    border-bottom: none;
  }

  .scan-table tbody tr:hover td {
    color: var(--accent-1);
  }

  .code-cell code {
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    background: rgba(42, 39, 36, 0.06);
    padding: 0.15em 0.4em;
    color: var(--color-text);
  }

  .table-empty {
    font-size: var(--size-sm);
    color: var(--color-subtle);
    padding: var(--space-md) 0;
  }

  /* Mobile */
  @media (max-width: 640px) {
    .stats {
      grid-template-columns: repeat(2, 1fr);
    }

    .scan-table th,
    .scan-table td {
      padding-right: 0.5rem;
    }
  }
</style>
